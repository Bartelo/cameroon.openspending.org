---
layout: default
title: Local Council Budget Transparency
---

<h1>Budget Transparency in the Adamawa Region</h1>
<br><br>

<style>
    #map svg .commune {
        stroke: #ccc;
    }   

    .details-content table {
        width: 100%;
        margin-bottom: 2em;
    }

    .details-content table .has-large {
        
    }

    .details-content table .has-large td {
        vertical-align: middle;
        padding-bottom: 1em;
    }

    .details-content .large {
        font-size: 2em;
        font-weight: bold;
    }
</style>

<div class="row">
    <div class="span8">
        <div id="map"></div>
    </div>
    <div class="span4">
        <h3>See how well Councils budget, compare them by:</h3>
        <ul>
            <li><a href="#" class="map-layer" data-layer="score">overall score</a></li>
            <li><a href="#" class="map-layer" data-layer="revenue">% of revenue realized</a></li>
            <li><a href="#" class="map-layer" data-layer="spending">% of expenditure realized</a></li>
            <li>documents produced:
                <ul>
                    <li><a href="#" class="map-layer" data-layer="document" data-document="adopted">Adopted Budget</a></li>
                    <li><a href="#" class="map-layer" data-layer="document" data-document="audit_report">Audit Report</a></li>
                    <li>...</li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<div class="row">
    <div class="span8">
        <h3>Ranking</h3>
        <table id="ranking" class="table table-striped table-condensed">
            <tr>
                <th>Council</th>
                <th>Score</th>
            </tr>
        </table>
    </div>
</div>

<div class="modal hide" id="details-overlay">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">Ã—</button>
        <h3>No title</h3>
    </div>
    <div class="modal-body">
    </div>
</div>

{% raw %}
<script id="details-overlay-content" type="application/handlebars">
    <div class="details-content">
        <table>
            <tr class="has-large">
                <td>Place:</td>
                <td class="large">{{rank}}</td>
                
                <td>Score:</td>
                <td class="large">{{score}}</td>
                <td>points</td>
            </tr>

            <tr class="has-large">
                <td>Revenue realized:</td>
                <td class="large">{{revenue_realized}}</td>
                
                <td>Spending realized:</td>
                <td class="large">{{spending_realized}}</td>
                <td></td>
            </tr>
        </table>

        <ul>
            <li>Key Documents</li>
            <li>Then:<ul>
                <li>Assets (Short-term and Long-term) published</li>
                <li>Aid Transparency</li>
                <li>References to programmes and beneficiaries</li>
                <li>KPI</li>
                <li>Citizen Budgets</li>
                <li>Council say in Budgeting</li>
                <li>Public has a say in Budgeting (PB)</li>
                <li>Time between reporting period & report</li>
                <li>Report after budget</li>
            </ul></li>
        </ul>
    </div>
</script>
{% endraw %}

<script>
    $(function() {
        score_colors = new chroma.ColorScale({
            colors: chroma.brewer.PuBu,
            limits: [0,60]
            });

        rev_colors = new chroma.ColorScale({
            colors: chroma.brewer.BuGn,
            limits: [0,130]
            });

        spend_colors = new chroma.ColorScale({
            colors: chroma.brewer.RdPu,
            limits: [0,130]
            });

        doc_colors = new chroma.ColorScale({
            colors: chroma.brewer.Spectral,
            limits: [-2,5]
            });

        $.get('/data/bti.json', function(bti_data) {
            //var bti_data = JSON.parse(bti_data);
            window.map = $K.map('#map');

            var showDetails = function(commune) {
                var data = bti_data[commune];
                var tmpl = Handlebars.compile($("#details-overlay-content").html());
                var $e = $("#details-overlay");
                $e.find("h3").html(data.sheet_name);
                $e.find(".modal-body").html(tmpl(data));
                $e.modal();
            }

            var colorizeMap = function(colorize) {
                map.choropleth({
                    data: function(e) {
                        return bti_data[e.commune];
                    },
                    key: 'commune',
                    colors: function(d, pathdata) {
                        if (!d) return '#ddd';
                        return colorize(d)
                    }
                });
            }

            var sorted_bti_data = _.sortBy(bti_data, function (e) { return e.rank; })
            _.each(sorted_bti_data, function(k) {
                $("#ranking").append("<tr data-commune='"+k.key+"'><td><a href='#'>"+
                    k.sheet_name+"</a></td><td>" + k.score + "</td></tr>")
            });

            $("#ranking a").click(function(e) { 
                var commune = $(e.currentTarget).parents('tr').data('commune');
                showDetails(commune);
                return false;
            });

            $("#ranking tr").mouseenter(function(e) { 
                var commune = $(e.currentTarget).data('commune');
                var path = map.getLayerPath('commune', commune);
                path.realFill = path.svgPath.attrs.fill;
                path.svgPath.attr({'fill': 'orange'});
                return false;
            });

            $("#ranking tr").mouseleave(function(e) { 
                var commune = $(e.currentTarget).data('commune');
                var path = map.getLayerPath('commune', commune);
                path.svgPath.attr({'fill': path.realFill});
                return false;
            });


            var colorizeScores = function(d) {
                if (d.score=='-') return '#ddd';
                return score_colors.getColor(d.score);
            }

            var colorizeRevenue = function(d) {
                return rev_colors.getColor(d.revenue_realized_num);
            }

            var colorizeSpending = function(d) {
                return spend_colors.getColor(d.spending_realized_num);
            }

            var colorizeDocument = function(doc) {
                return function(d) {
                    return doc_colors.getColor(d.documents[doc].score);
                };
            }

            $(".map-layer").click(function(e) {
                var layer = $(e.currentTarget).data('layer');
                if (layer == 'score') {
                    colorizeMap(colorizeScores);
                } else if (layer == 'revenue') {
                    colorizeMap(colorizeRevenue);
                } else if (layer == 'spending') {
                    colorizeMap(colorizeSpending);
                } else if (layer == 'document') {
                    var doc = $(e.currentTarget).data('document');
                    colorizeMap(colorizeDocument(doc));
                }
                return false;
            });

            map.loadMap('/img/adamawa.svg', function(map) {
                map.addLayer({
                    id: 'commune',
                    key: 'commune'
                });

                colorizeMap(colorizeScores);
                
                map.onLayerEvent('click', function(d) {
                    showDetails(d.commune);
                });

                map.tooltips({
                    layer: 'commune',
                    content: function(data) {
                        return data.commune;
                    },
                    style: { 
                        name: 'dark'
                    }
                });
            });
        });
    });
</script>
